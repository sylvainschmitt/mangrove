```{r setuphiermodel3, include=FALSE, cache=F}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(ggfortify)
library(rstan)
library(loo)
library(bayesplot)
theme_set(bayesplot::theme_default())
options(mc.cores = 4)
rstan_options(auto_write = TRUE)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
```

# Hierarchical model - Poisson log

```{r mdatahier3}
data <- read_tsv("data/mangrove_data.txt") %>% 
  dplyr::rename(plot = `Placettes`,
                id = `ID`,
                height = `Hauteur(m)`,
                d1 = `Diametre1(mm)`,
                d2 = `Diametre2(mm)`,
                diameter = `Moyennediam(mm)`,
                branches = `Branches(N)`,
                fruits = `Fruits(N)`,
                flowers = `Fleurs(N)`,
                pflower= `Presencefleurs(1/0)`,
                nci1 = `Competition_1(cm)`,
                nci2 = `Competition_2(cm)`,
                nci3 = `Competition_3(cm)`,
                nci = `Moyennecompetition(cm)`,
                density = `Densite(trees/m2)`,
                date = `Date`,
                time = `Heure`,
                soil = `Typesol`,
                openness = `Ouverture`,
                age = `Agemax(months)`,
                shore = `Distance(fromShore)`) %>% 
  mutate(time = as.numeric(gsub("h", "", time))) %>% 
  dplyr::select(
    id,
    branches, fruits, flowers,
    nci, density, shore,
    soil, openness,
    plot
  ) %>% 
  mutate(plotNum = as.numeric(as.factor(plot))) %>% 
  mutate_at(c("nci", "density", "shore"),
            scale) %>% 
  mutate_at(c("nci", "density", "shore"),
            as.vector)
mdata_branches <- list(
  I = nrow(data),
  S = max(data$soil),
  O = max(data$openness),
  P = max(data$plotNum),
  y = data$branches,
  nci = data$nci,
  density = data$density,
  shore = data$shore,
  soil = data$soil,
  openness = data$openness,
  plot = data$plotNum
)
mdata_fruits <- list(
  I = nrow(data),
  S = max(data$soil),
  O = max(data$openness),
  P = max(data$plotNum),
  y = data$fruits,
  nci = data$nci,
  density = data$density,
  shore = data$shore,
  soil = data$soil,
  openness = data$openness,
  plot = data$plotNum
)
mdata_flowers <- list(
  I = nrow(data),
  S = max(data$soil),
  O = max(data$openness),
  P = max(data$plotNum),
  y = data$flowers,
  nci = data$nci,
  density = data$density,
  shore = data$shore,
  soil = data$soil,
  openness = data$openness,
  plot = data$plotNum
)
```

## Hierarchical model

We are now adding an hidden state to the best model. Let's assume there are two genetically distinct types of individuals that can be differentiated based on their flowering date : early or late flowering. We want to identify individuals with the genetic potential of flowering earlier. Let's p be the probability of a late individual i and 1âˆ’p the probability of an early individual.

$$y_{i,p} \sim \mathcal Plog (\alpha_p^l + \beta_1*nci_i + \beta_2*density_p + \beta_3*shore_p, \sigma)$$
$$\mu_p \sim \mathcal N (\alpha^l, \sigma_{plot})$$

$$l\in{1,2}|z_{i,p}\sim\mathcal B(p)$$

### Branches

```{r hierFitBranches, eval=FALSE}
m_hierpois <- stan_model("model3/hierpois.stan")
f_hier_branches <- sampling(m_hierpois, mdata_branches, save_warmup = F, chains = 2, cores = 2, include = F, pars = c("mu_p", "odd"))
save(f_hier_branches, file = "save/hierbranches.Rdata")
```

```{r hierOutBranches}
load("save/hierbranches.Rdata")
cowplot::plot_grid(
  mcmc_trace(f_hier_branches, regex_pars = c("mu0", "diff", "beta", "sigma")),
  mcmc_intervals(f_hier_branches, regex_pars = c("mu0", "diff", "beta", "alpha", "gamma", "sigma")),
  ppc_dens_overlay(y = data$branches, as.matrix(f_hier_branches, pars = "prediction")[1:100, ]),
  nrow = 2
)
```

### Flowers

```{r hierFitFlowers, eval=FALSE}
m_hierpois <- stan_model("model3/hierpois.stan")
f_hier_flowers <- sampling(m_hierpois, mdata_flowers, save_warmup = F, chains = 2, cores = 2, include = F, pars = c("mu_p", "odd"))
save(f_hier_flowers, file = "save/hierflowers.Rdata")
```

```{r hierOutFlowers}
load("save/hierflowers.Rdata")
cowplot::plot_grid(
  mcmc_trace(f_hier_flowers, regex_pars = c("mu0", "diff", "beta", "sigma")),
  mcmc_intervals(f_hier_flowers, regex_pars = c("mu0", "diff", "beta", "alpha", "gamma", "sigma")),
  ppc_dens_overlay(y = data$flowers, as.matrix(f_hier_flowers, pars = "prediction")[1:100, ]),
  nrow = 2
)
```

### Fruits

```{r hierFitFruits, eval=FALSE}
m_hierpois <- stan_model("model3/hierpois.stan")
f_hier_fruits <- sampling(m_hierpois, mdata_fruits, save_warmup = F, chains = 2, cores = 2, include = F, pars = c("mu_p", "odd"))
save(f_hier_fruits, file = "save/hierfruits.Rdata")
```

```{r hierOutFruits}
load("save/hierfruits.Rdata")
cowplot::plot_grid(
  mcmc_trace(f_hier_fruits, regex_pars = c("mu0", "diff", "beta", "sigma")),
  mcmc_intervals(f_hier_fruits, regex_pars = c("mu0", "diff", "beta", "alpha", "gamma", "sigma")),
  ppc_dens_overlay(y = data$branches, as.matrix(f_hier_fruits, pars = "prediction")[1:100, ]),
  nrow = 2
)
```

## Back to data

```{r histpheno}
read_tsv("data/mangrove_data.txt") %>% 
  dplyr::rename(plot = `Placettes`,
                id = `ID`,
                height = `Hauteur(m)`,
                d1 = `Diametre1(mm)`,
                d2 = `Diametre2(mm)`,
                diameter = `Moyennediam(mm)`,
                branches = `Branches(N)`,
                fruits = `Fruits(N)`,
                flowers = `Fleurs(N)`,
                pflower= `Presencefleurs(1/0)`,
                nci1 = `Competition_1(cm)`,
                nci2 = `Competition_2(cm)`,
                nci3 = `Competition_3(cm)`,
                nci = `Moyennecompetition(cm)`,
                density = `Densite(trees/m2)`,
                date = `Date`,
                time = `Heure`,
                soil = `Typesol`,
                openness = `Ouverture`,
                age = `Agemax(months)`,
                shore = `Distance(fromShore)`) %>% 
  mutate(time = as.numeric(gsub("h", "", time))) %>% 
  dplyr::select(height, diameter, branches, fruits, flowers, pflower) %>% 
  reshape2::melt("pflower") %>% 
  mutate(pflower = as.factor(pflower)) %>% 
  ggplot(aes(value)) +
  geom_histogram(aes(y = ..density.., fill = pflower), position = "dodge") +
  geom_density() +
  facet_wrap(~ variable, scales = "free")
```

```{r histvar}
read_tsv("data/mangrove_data.txt") %>% 
  dplyr::rename(plot = `Placettes`,
                id = `ID`,
                height = `Hauteur(m)`,
                d1 = `Diametre1(mm)`,
                d2 = `Diametre2(mm)`,
                diameter = `Moyennediam(mm)`,
                branches = `Branches(N)`,
                fruits = `Fruits(N)`,
                flowers = `Fleurs(N)`,
                pflower= `Presencefleurs(1/0)`,
                nci1 = `Competition_1(cm)`,
                nci2 = `Competition_2(cm)`,
                nci3 = `Competition_3(cm)`,
                nci = `Moyennecompetition(cm)`,
                density = `Densite(trees/m2)`,
                date = `Date`,
                time = `Heure`,
                soil = `Typesol`,
                openness = `Ouverture`,
                age = `Agemax(months)`,
                shore = `Distance(fromShore)`) %>% 
  mutate(time = as.numeric(gsub("h", "", time))) %>% 
  dplyr::select(shore, openness, soil, density, nci, pflower) %>% 
  reshape2::melt("pflower") %>% 
  mutate(pflower = as.factor(pflower)) %>% 
  ggplot(aes(value)) +
  geom_histogram(aes(y = ..density.., fill = pflower), position = "dodge") +
  geom_density(aes(col = pflower)) +
  facet_wrap(~ variable, scales = "free")
```

```{r scattervarpheno}
read_tsv("data/mangrove_data.txt") %>% 
  dplyr::rename(plot = `Placettes`,
                id = `ID`,
                height = `Hauteur(m)`,
                d1 = `Diametre1(mm)`,
                d2 = `Diametre2(mm)`,
                diameter = `Moyennediam(mm)`,
                branches = `Branches(N)`,
                fruits = `Fruits(N)`,
                flowers = `Fleurs(N)`,
                pflower= `Presencefleurs(1/0)`,
                nci1 = `Competition_1(cm)`,
                nci2 = `Competition_2(cm)`,
                nci3 = `Competition_3(cm)`,
                nci = `Moyennecompetition(cm)`,
                density = `Densite(trees/m2)`,
                date = `Date`,
                time = `Heure`,
                soil = `Typesol`,
                openness = `Ouverture`,
                age = `Agemax(months)`,
                shore = `Distance(fromShore)`) %>% 
  mutate(time = as.numeric(gsub("h", "", time))) %>% 
  dplyr::select(height, diameter, branches, fruits, flowers, 
                shore, openness, soil, density, nci,
                pflower, ) %>% 
  reshape2::melt(c("pflower", "shore", "openness", "soil", "density", "nci"),
                 variable.name = "phenotype", value.name = "phenotypic.value") %>% 
  reshape2::melt(c("pflower", "phenotype", "phenotypic.value")) %>% 
  mutate(pflower = as.factor(pflower)) %>% 
  ggplot(aes(value, phenotypic.value, col = pflower)) +
  geom_point() +
  geom_smooth(method = "lm", aes(group = NA)) +
  facet_grid(phenotype ~ variable, scales = "free")
```
